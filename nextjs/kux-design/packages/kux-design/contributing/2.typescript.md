# 组件代码开发说明

本文档仅对typescript的开发做说明, 组件开发过程中的调试请阅读 [stories 用例及文档](./4.doc.md)

若你还不熟悉 typescript, 可以阅读文档:
* [typescript 手册](https://tslang.com.cn/zh/docs/handbook/intro.html)
* [react 中使用 typescript](https://zh-hans.react.dev/learn/typescript)

若你已经熟悉 typescript, 也可以阅读更多相关文档[Awesome Typescript](https://github.com/semlinker/awesome-typescript/blob/master/README-zh.md)


## 依赖的使用
1. [不要使用 lodash/underscore 等类似工具库](https://github.com/you-dont-need/You-Dont-Need-Lodash-Underscore), 使用现代JS实现
2. 组件库依赖了 `@kux/app-sdk`, 提供了常用的工具方法, 具体可查看 <packages/kux-app-sdk/README.md>
3. 新增依赖请注意依赖的性能及体积
4. 若新增的依赖仅部分组件使用, 如无必要, 请尽量使用 `import('xxx')` 方式异步加载以保证组件的轻量

举例, 分享海报中使用了 `qrcode.react`, 但是该组件使用频率低, 该依赖也不需要立即加载, 此处故使用了懒加载
```tsx
import { Suspense } from 'react';
const QRCodeCanvas = lazy(() => import('qrcode.react').then(res => ({ default: res.QRCodeCanvas })));

// 以下为简化的代码
// 海报视图view
function ShareView(props) {
  return (
    <div>
      <Suspense>
        <QRCodeCanvas size={256} value={props.link} id="qrCode-id" level="Q" />
      </Suspense>
    </div>
  )
}

```


## 尺寸规范
尺寸的属性应固定使用名称 `size`, `src/shared-type.ts` 中定义了常用的尺寸, 可根据需要组合类型.

* 组件支持一致的尺寸类型： `'mini' | 'small' | 'medium' | 'large' | 'huge' | 'auto'`
* 组件可根据需求实现具体尺寸
* 一般来说, 组件的默认尺寸为 `medium`
* 若组件有固定的响应式使用场景(比如大屏幕使用 `medium` 小屏幕使用 `small`), 则可以增加 `auto` 尺寸, 并作为默认值


```ts
import { type ISizeExtended } from '@/shared-type';
export interface ISomeComponentProps {
  /**
   * 尺寸
   */
  size?: ISizeExtended;
}
```


## 方向规范
涉及横纵方向的, 一般属性命名为 `direction`, 可选值有 `horizontal` `vertical`

使用公共类型 `IDirection` 来定义

```ts
import { type IDirection } from '@/shared-type';

export interface ISomeComponentProps {
  /**
   * 方向
   */
  direction?: IDirection;
}
```

## 通用 props 规范

### className / style

* 所有组件应当支持 `className`
* `style` 可选支持，样式固定组件可不支持

```tsx
<Button className="my-btn" style={{ marginTop: 10 }} />
```

### 表单类组件

* 必须支持 `onChange`, `value`, `defaultValue`, `disabled`
* `value` 类型不限，根据需求定义

表单组件公共类型定义及 hook 处理已经封装在 `src/hooks/useFormInput.ts` 中.

示例:
```ts
import { clx } from '@/common';
import { type IInputSharedProps, useFormInput } from '@/hooks';

export interface IInputProps extends IInputSharedProps<string> {
  className?: string
}

export function Input(props: IInputProps) {
  const { value, onChange, disabled } = useFormInput(props);

  return (<input
    className={clx('kux-input', props.className)}
    value={value}
    disabled={disabled}
    onChange={(e) => onChange(e.target.value)} />)
}
```

---

## 资源引用

* 所有资源必须放置在对应组件相关文件夹内
* 引用路径中使用 `?url`
* svg 当作 react 组件使用的场景, 则使用 `?react` 查询参数

```ts
// 获取的是地址
import iconUrl from './assets/icon.svg?url';
// 获取的是react 组件
import OtherIcon from './assets/other.svg?react';
```

---

## 类型名命名规范

* props 类型使用 `I<ComponentName>Props` 格式
* 所有类型定义必须有 jsdoc 块注释

```ts
/** Props for Button component */
export interface IButtonProps {
  /** Whether the button is disabled */
  disabled?: boolean;
  /** Click handler */
  onClick?: () => void;
}
```

---

## 组件导出规范

* 禁止使用 `export default`
* 优先使用 `export function ComponentName()` 方式

```tsx
export function Button(props: IButtonProps) {
  return <button className="my-button" {...props} />;
}
```

## z-index 管理

* 所有涉及层叠上下文的组件必须使用统一的 `useZIndex(visible?: boolean)` hook 管理层级，避免冲突

## 动画
组件库中使用 [`framer-motion@5`](https://motion.dev/docs/react-upgrade-guide#5-0) 来实现动画(使用v5是因为其是支持 react 17 的最高版本).

组件实现中可按需增加动画, 具体可参考组件 `Segmented` 与 `Switch` 的使用案例


## SSR 安全性
* 组件的立即执行代码(即非hook内的代码)避免使用平台专有的的能力, 如浏览器相关API
* 若需判断平台，可使用 `app.global` 提供的全局环境变量判断运行环境

```ts
if (app.global.window) {
  // some browser actions
}
useEffect(() => {
  // some safer actions
  document.querySelector('.xxx')
}, []);
```


## 可访问性（Accessibility）规范

* 所有组件应尽量支持 `aria-*` 属性透传
* 可交互组件应处理 `tabIndex` 与键盘事件
* 对话框、弹出层等应使用正确的 `role` 属性，如：`role="dialog"`, `aria-modal="true"`

参考文档：

* WAI-ARIA：[https://www.w3.org/WAI/ARIA/](https://www.w3.org/WAI/ARIA/)
* React ARIA：[https://react-spectrum.adobe.com/react-aria/](https://react-spectrum.adobe.com/react-aria/)

---

## 调试与开发体验
* 支持开发时 warning 输出，例如未提供必要 props 时打印 console.warn（建议只在 `_DEV_` 环境下）

```ts
if (_DEV_ && !props.onChange) {
  console.warn('[Input] Missing onChange handler in controlled mode');
}
```
